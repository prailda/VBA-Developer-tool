# Проектная техническая спецификация для надстройки Office API на JavaScript

## Основы разработки надстройки Office API на JavaScript в VS Code

### Подготовка среды разработки

#### 1. Необходимые расширения в VS Code

Для комфортной разработки надстроек Office вам понадобятся следующие расширения:

* **Debugger for Microsoft Edge**: Позволяет отлаживать JavaScript код вашей надстройки, который выполняется в элементе управления WebView2 (на базе Edge Chromium) в Office.
* **ESLint**: Помогает находить и исправлять проблемы в вашем JavaScript коде, обеспечивая его качество и соответствие стандартам.
* **Prettier - Code formatter**: Автоматически форматирует ваш код, делая его более читаемым и единообразным.
* **Live Server (опционально, но полезно для UI)**: Позволяет быстро просматривать изменения в HTML/CSS файлах интерфейса.
* **Office Add-in Tools (от Microsoft)**: Хотя основной инструмент `yo office` используется через терминал, это расширение может предоставить полезные команды и интеграцию.

Вы можете установить их через вкладку "Расширения" (Ctrl+Shift+X) в VS Code, выполнив поиск по названию.

#### 2. Создание проекта надстройки

Самый надежный способ создать проект надстройки Office — использовать генератор Yeoman для Office Add-ins (`yo office`).

1. **Установите Node.js и npm**: Если у вас их нет, скачайте и установите с [nodejs.org](https://nodejs.org/). npm (Node Package Manager) устанавливается вместе с Node.js.
2. **Установите Yeoman и генератор Office Add-in**:
    Откройте терминал в VS Code (Ctrl+\`) и выполните команды:

    ````bash
    npm install -g yo generator-office
    ````

3. **Создайте проект**:
    В терминале перейдите в каталог, где вы хотите создать проект (например, `c:\Users\dalis\OfficeAddinApps\Java Script AddIn`), и выполните:

    ````bash
    yo office
    ````

    Далее следуйте инструкциям генератора:
    * **Choose a project type**: Выберите "Office Add-in Task Pane project".
    * **Choose a script type**: Выберите "JavaScript".
    * **What do you want to name your add-in?**: Введите имя вашей надстройки (например, "MyExcelAddin").
    * **Which Office client application would you like to support?**: Выберите "Excel".

    Генератор создаст структуру проекта с базовыми файлами.

#### 3. Пакеты и модули

Проект, созданный `yo office`, уже будет включать основные пакеты:

* `@microsoft/office-js`: Основная библиотека Office JavaScript API.
* `webpack`, `webpack-cli`, `webpack-dev-server`: Для сборки проекта и локального сервера разработки.
* `html-webpack-plugin`, `copy-webpack-plugin`: Плагины для Webpack.
* `office-addin-debugging`, `office-addin-manifest`: Инструменты для отладки и работы с манифестом.

**Добавление пакетов**:
Если вам понадобятся дополнительные библиотеки (например, для работы с UI, запросами к API, утилитами), используйте npm:

````bash
npm install <имя-пакета>
````

Или для зависимостей разработки:

````bash
npm install <имя-пакета> --save-dev
````

Всегда проверяйте совместимость и безопасность пакетов перед добавлением.

#### 4. Параметры рабочей среды

VS Code позволяет настроить рабочую среду через файл `.vscode/settings.json` в вашем проекте.

Пример полезных настроек:

````json
{
    "editor.formatOnSave": true, // Автоматическое форматирование при сохранении (требует Prettier)
    "eslint.validate": [
        "javascript",
        "html"
    ],
    "eslint.alwaysShowStatus": true,
    "files.associations": {
        "*.html": "html",
        "*.js": "javascript"
    },
    "debug.javascript.usePreview": true, // Для использования нового отладчика JS
    // Настройки для отладки надстройки Office (обычно генерируются yo office)
    // "debug.configurations": [ ... ]
}
````

#### Итоговый чек-лист для старта разработки

1. [ ] Установлен Node.js и npm.
2. [ ] Установлены глобально `yo` и `generator-office`.
3. [ ] Проект надстройки создан с помощью `yo office`.
4. [ ] Установлены рекомендуемые расширения VS Code (Debugger for Edge, ESLint, Prettier).
5. [ ] Настроен `.vscode/settings.json` для форматирования и линтинга.
6. [ ] Вы можете запустить проект (`npm start`) и увидеть панель задач в Excel.
7. [ ] Вы можете отлаживать код JavaScript надстройки в VS Code.

### Проектная техническая спецификация

После настройки среды переходим к проектированию.

#### Требования к проекту и анализ критериев качества

Прежде чем писать код, важно определить:

* **Цель надстройки**: Какую проблему пользователя она решает? Какие задачи автоматизирует или упрощает?
* **Основные функции**: Список ключевых возможностей.
* **Целевая аудитория**: Кто будет использовать надстройку? Это повлияет на дизайн UI/UX.
* **Критерии качества**:
  * **Надежность**: Надстройка должна работать без сбоев, корректно обрабатывать ошибки и граничные случаи.
  * **Производительность**: Быстрый отклик интерфейса, эффективное использование Office API для предотвращения зависаний Excel.
  * **Безопасность**: Защита данных пользователя, отсутствие уязвимостей.
  * **Удобство использования (UX)**: Интуитивно понятный интерфейс, минимальное количество шагов для выполнения задач.
  * **Поддерживаемость**: Чистый, хорошо документированный код, модульная архитектура для легкого внесения изменений и исправлений.
  * **Совместимость**: Корректная работа на различных платформах (Windows, Mac, Online), где поддерживается Office Add-ins.

#### Стратегия реализации и концепция проекта

Исходя из требований, формируется концепция. Например, если надстройка предназначена для сложной обработки данных из листа Excel, визуализации и отправки отчета, концепция может включать:

* **Модуль взаимодействия с Excel**: Чтение/запись данных, форматирование.
* **Модуль обработки данных**: Логика анализа, вычислений.
* **Модуль UI**: Отображение элементов управления, результатов, прогресса.
* **Модуль API-клиента (если нужно)**: Взаимодействие с внешними сервисами.

**Структура каталогов проекта (пример)**:

```text
my-excel-addin/
├── dist/                     // Собранные файлы для развертывания
├── manifest.xml              // Манифест надстройки
├── package.json
├── webpack.config.js
├── .eslintrc.js
├── src/                      // Исходный код
│   ├── taskpane/             // Код для панели задач
│   │   ├── taskpane.html
│   │   ├── taskpane.js       // Основной JS файл для панели задач (точка входа)
│   │   ├── taskpane.css
│   │   └── components/       // Компоненты UI (если используется фреймворк или модульный подход)
│   │       ├── button.js
│   │       └── input.js
│   ├── commands/             // Код для команд надстройки (если используются)
│   │   └── commands.js
│   ├── core/                 // Ядро логики, не зависящее от UI
│   │   ├── excel-service.js  // Сервис для работы с Excel API
│   │   ├── data-processor.js // Обработчик данных
│   │   └── utils.js          // Вспомогательные функции
│   ├── assets/               // Статические ресурсы (иконки, изображения)
│   └── common/               // Общие модули, константы
│       └── constants.js
└── docs/                     // Документация
    ├── architecture.md
    └── user-guide.md
```

#### 1. Архитектурная схема проекта (предварительная)

Мы будем использовать модульный подход, разделяя логику взаимодействия с Excel, обработку данных и пользовательский интерфейс.

* **Схема движения потоков данных**:
    Пользователь взаимодействует с UI (в `taskpane.html/js`) -> UI вызывает функции из `excel-service.js` для чтения данных из Excel -> `excel-service.js` возвращает данные -> `taskpane.js` передает данные в `data-processor.js` для обработки -> `data-processor.js` возвращает результат -> `taskpane.js` обновляет UI и/или записывает результат обратно в Excel через `excel-service.js`.

* **Логика взаимодействия между модулями и классами**:
  * `taskpane.js`: Оркестратор. Обрабатывает события UI, вызывает сервисы, обновляет UI.
  * `excel-service.js`: Инкапсулирует всю логику работы с `Office.context.document.workbook` и его объектами. Предоставляет простые методы (например, `getSelectedRangeData()`, `writeDataToRange(data, address)`).
  * `data-processor.js`: Чистая логика обработки данных, не зависит от Office API. Получает данные, обрабатывает, возвращает результат.
  * `components/*.js`: (Если используются) Переиспользуемые компоненты UI.

* **Цепочка вызовов между компонентами (пример для функции "Обработать выбранные данные")**:
    1. Пользователь нажимает кнопку "Обработать" в `taskpane.html`.
    2. `taskpane.js` (обработчик события) -> `excelService.getSelectedRangeData()`.
    3. `excelService.getSelectedRangeData()` -> `Excel.run(async context => { ... context.sync(); })`.
    4. `excelService` возвращает данные (Promise).
    5. `taskpane.js` (после разрешения Promise) -> `dataProcessor.process(data)`.
    6. `dataProcessor.process()` выполняет вычисления.
    7. `dataProcessor` возвращает обработанные данные.
    8. `taskpane.js` -> `excelService.writeDataToRange(processedData, 'Sheet1!C1')` (или обновляет UI).
    9. `excelService.writeDataToRange()` -> `Excel.run(...)`.
    10. `taskpane.js` отображает сообщение об успехе/ошибке.

* **Точка входа и инициализация / деинициализация**:
  * **Точка входа**: `Office.onReady()` или `Office.initialize = function () { ... }` в `taskpane.js`. Здесь происходит инициализация UI, подписка на события.
  * **Инициализация**: Загрузка необходимых данных, настройка начального состояния UI.
  * **Деинициализация**: Обычно не требует явных действий для простых надстроек, так как среда выполнения (браузерный компонент) очищается при закрытии панели задач. Если есть подписки на события документа, их стоит отключать.

* **Общая логика работы приложения**:
    Надстройка представляет собой веб-приложение, работающее внутри Excel. Она реагирует на действия пользователя в панели задач, взаимодействует с книгой Excel через Office JavaScript API и отображает результаты.

**Диаграмма Mermaid (Архитектура)**:

````mermaid
graph TD
    subgraph "Task Pane (UI & Orchestration)"
        TP_HTML[taskpane.html]
        TP_JS[taskpane.js]
        UI_COMP[UI Components]
    end

    subgraph "Core Logic"
        EXCEL_SERVICE[excel-service.js]
        DATA_PROCESSOR[data-processor.js]
        UTILS[utils.js]
    end

    subgraph "Office Host (Excel)"
        EXCEL_API[Office JavaScript API for Excel]
        WORKBOOK[Excel Workbook]
    end

    USER[User] -- Interacts --> TP_HTML
    TP_HTML -- Events --> TP_JS
    TP_JS -- Calls --> EXCEL_SERVICE
    TP_JS -- Calls --> DATA_PROCESSOR
    TP_JS -- Updates --> UI_COMP
    UI_COMP -- Renders in --> TP_HTML

    EXCEL_SERVICE -- Uses --> EXCEL_API
    EXCEL_API -- Interacts --> WORKBOOK
    DATA_PROCESSOR -- Processes data for --> TP_JS
    UTILS -- Provides helpers to --> EXCEL_SERVICE
    UTILS -- Provides helpers to --> DATA_PROCESSOR
    UTILS -- Provides helpers to --> TP_JS
````

#### 2. Детализация каждого компонента (предварительная)

* **`excel-service.js`**:
  * **Поля**: Нет явных полей состояния, сервис stateless.
  * **Методы**:
    * `async getSelectedRangeAddress()`: Возвращает адрес выделенного диапазона.
    * `async getSelectedRangeData()`: Читает данные из выделенного диапазона.
    * `async getRangeData(address: string)`: Читает данные из указанного диапазона.
    * `async writeDataToRange(data: any[][], address: string)`: Записывает данные в указанный диапазон.
    * `async clearRange(address: string)`: Очищает указанный диапазон.
    * `async setRangeFormat(address: string, format: Excel.CellPropertiesFormat)`: Устанавливает форматирование для диапазона.
    * `async createTable(address: string, headers: string[], hasHeaders: boolean)`: Создает таблицу Excel.
    * `async addWorksheet(name?: string)`: Добавляет новый лист.
  * **Паттерны**: Фасад (скрывает сложность `Excel.run` и `context.sync()`). Service Layer.
  * **Логика работы**: Каждый метод оборачивает вызовы Office API в `Excel.run`. Обрабатывает ошибки и возвращает Promise.
  * **Алгоритмы**: Использование `context.load()` для загрузки только необходимых свойств объектов Excel для оптимизации производительности. Пакетная обработка запросов внутри `Excel.run`.

* **`data-processor.js`**:
  * **Поля**: Зависят от конкретной задачи (например, `configOptions`).
  * **Методы**:
    * `process(data: any[][], options?: any)`: Основной метод обработки.
    * Вспомогательные приватные методы для различных этапов обработки.
  * **Паттерны**: Может использовать Стратегию, если есть разные алгоритмы обработки. Чистые функции, где это возможно.
  * **Логика работы**: Принимает данные, выполняет вычисления/преобразования согласно бизнес-логике, возвращает результат. Не должен содержать вызовов Office API.
  * **Алгоритмы**: Зависят от задачи. Важно обеспечить эффективность для больших объемов данных.

* **`taskpane.js`**:
  * **Поля**: Ссылки на элементы DOM, состояние UI (например, `isLoading`, `errorMessage`).
  * **Методы**:
    * `onOfficeReady()`: Инициализация, привязка обработчиков событий.
    * `handleProcessDataClick()`: Обработчик нажатия кнопки "Обработать".
    * `updateUI(dataToShow: any)`: Обновление элементов интерфейса.
    * `showError(message: string)`: Отображение сообщения об ошибке.
    * `showLoading(isLoading: boolean)`: Управление индикатором загрузки.
  * **События**: Обработка событий от элементов DOM (клики, изменения ввода).
  * **Паттерны**: Controller (в контексте MVC/MVP, если UI сложный). Event Listeners.
  * **Логика работы**: Связывает UI с бизнес-логикой и сервисами. Управляет состоянием UI.

#### 3. Дизайн компонентов интерфейса (полный)

Предположим, наша надстройка выполняет простую операцию: берет данные из выбранного диапазона, умножает числа на 2 и выводит результат в другой диапазон или в самой панели.

* **Структура компонентов интерфейса (`taskpane.html`)**:

    ````html
    <!-- filepath: src/taskpane/taskpane.html -->
    <body>
        <div class="container">
            <h1 class="ms-font-xl">Обработка данных Excel</h1>
            <p class="ms-font-m">Выберите диапазон с числами и нажмите "Обработать".</p>

            <div class="ms-Grid" dir="ltr">
                <div class="ms-Grid-row">
                    <div class="ms-Grid-col ms-sm12 ms-md12 ms-lg12">
                        <label for="outputAddress" class="ms-Label">Адрес для вывода результата (например, Sheet1!C1):</label>
                        <input type="text" id="outputAddress" class="ms-TextField-field" value="Sheet1!C1">
                    </div>
                </div>
                <div class="ms-Grid-row">
                    <div class="ms-Grid-col ms-sm12 ms-md12 ms-lg12">
                        <button id="processButton" class="ms-Button ms-Button--primary">
                            <span class="ms-Button-label">Обработать выбранные данные</span>
                        </button>
                    </div>
                </div>
                <div class="ms-Grid-row">
                    <div class="ms-Grid-col ms-sm12 ms-md12 ms-lg12">
                        <div id="status" class="ms-font-m"></div>
                    </div>
                </div>
                 <div class="ms-Grid-row">
                    <div class="ms-Grid-col ms-sm12 ms-md12 ms-lg12">
                        <div id="loadingIndicator" style="display: none;">
                            <div class="ms-Spinner ms-Spinner--large"></div>
                            <p>Обработка...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    ````

* **Положение и размеры**: Используем Fluent UI (ранее Office UI Fabric) для стилизации и сетки. Классы `ms-Grid`, `ms-Grid-row`, `ms-Grid-col` помогают в разметке.
  * Заголовок (`h1`) и описание (`p`) сверху.
  * Поле ввода для адреса вывода (`input#outputAddress`) с меткой (`label`).
  * Кнопка "Обработать" (`button#processButton`).
  * Область для сообщений о статусе/ошибках (`div#status`).
  * Индикатор загрузки (`div#loadingIndicator`).

* **Стили и форматирование**:
  * Подключаем Fluent UI CSS (обычно `office-ui-fabric-core` или более новые `@fluentui/react-components` если используется React, но для чистого JS можно использовать CDN или npm пакет с CSS). В проекте `yo office` обычно уже есть базовая стилизация.
  * Используем классы Fluent UI: `ms-font-xl`, `ms-Label`, `ms-TextField-field`, `ms-Button`, `ms-Button--primary`, `ms-Spinner`.
  * Файл `taskpane.css` для кастомных стилей:

    ````css
    // filepath: src/taskpane/taskpane.css
    .container {
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px; /* Расстояние между основными блоками */
    }

    #loadingIndicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 10px;
    }

    #status {
        margin-top: 10px;
        padding: 8px;
        border-radius: 4px;
    }

    .status-success {
        background-color: #dff0d8;
        color: #3c763d;
        border: 1px solid #d6e9c6;
    }

    .status-error {
        background-color: #f2dede;
        color: #a94442;
        border: 1px solid #ebccd1;
    }
    ````

* **Пользовательские сценарии использования**:
    1. **Успешный сценарий**:
        * Пользователь открывает Excel, запускает надстройку.
        * Панель задач открывается.
        * Пользователь выбирает диапазон ячеек с числами в Excel (например, `A1:B2`).
        * Пользователь вводит адрес для вывода в поле "Адрес для вывода результата" (например, `D1`).
        * Пользователь нажимает кнопку "Обработать выбранные данные".
        * Отображается индикатор загрузки.
        * Надстройка читает данные из `A1:B2`.
        * Надстройка умножает каждое число на 2.
        * Надстройка записывает результат в диапазон, начиная с `D1`.
        * Индикатор загрузки скрывается.
        * В области статуса появляется сообщение "Данные успешно обработаны и записаны в D1:E2".
    2. **Сценарий с ошибкой (не выбран диапазон)**:
        * ...Пользователь не выбрал диапазон в Excel.
        * Пользователь нажимает "Обработать".
        * Индикатор загрузки не отображается (или кратковременно).
        * В области статуса появляется сообщение об ошибке "Ошибка: Пожалуйста, выберите диапазон ячеек для обработки."
    3. **Сценарий с ошибкой (неверный адрес вывода)**:
        * ...Пользователь вводит некорректный адрес, например, "АБВГД".
        * Пользователь нажимает "Обработать".
        * Отображается индикатор загрузки.
        * При попытке записи данных возникает ошибка Office API.
        * Индикатор загрузки скрывается.
        * В области статуса появляется сообщение "Ошибка: Не удалось записать данные. Указан неверный адрес."
    4. **Сценарий с нечисловыми данными**:
        * Пользователь выбирает диапазон, содержащий текст.
        * Нажимает "Обработать".
        * Надстройка пытается умножить текст на 2 (что даст `NaN` или ошибку, в зависимости от реализации `data-processor.js`).
        * Результат (например, ячейки с `NaN` или исходный текст) записывается.
        * Сообщение "Данные обработаны. Нечисловые значения проигнорированы/оставлены без изменений." (Требует соответствующей логики в `data-processor.js`).

### Процесс разработки

1. **Модули инфраструктуры**:
    * Начните с `excel-service.js`. Реализуйте базовые функции чтения/записи. Тщательно протестируйте их, используя `console.log` или отладчик VS Code, вызывая их из `taskpane.js` по нажатию тестовых кнопок.
    * Настройте обработку ошибок в `excel-service.js` (например, `try...catch` внутри `Excel.run`).

2. **Основной функционал**:
    * Реализуйте `data-processor.js`. Начните с простой логики (умножение на 2). Можете написать для него юнит-тесты, так как он не зависит от Office.
    * Интегрируйте `data-processor.js` в `taskpane.js`.

3. **UI и UX**:
    * Создайте HTML-структуру в `taskpane.html`.
    * В `taskpane.js` напишите код для:
        * Инициализации (`Office.onReady`).
        * Привязки обработчиков к кнопкам и полям ввода.
        * Вызова `excel-service.js` и `data-processor.js`.
        * Обновления `div#status` и управления `div#loadingIndicator`.
    * Стилизуйте с помощью `taskpane.css` и Fluent UI.
    * Протестируйте пользовательские сценарии, обращая внимание на обратную связь для пользователя (сообщения, индикаторы).

4. **Тестирование и отладка**:
    * Используйте `npm start` для запуска надстройки. Это запустит локальный сервер и позволит загрузить надстройку в Excel (sideloading).
    * В VS Code настройте конфигурацию отладки (обычно `yo office` создает ее в `.vscode/launch.json`). Выберите "Attach to Office Add-ins" или "Launch Edge (WebView)" и запустите отладчик (F5).
    * Ставьте точки останова, проверяйте переменные.
    * Тестируйте на разных данных, граничных случаях.

Этот подробный план должен помочь вам начать разработку мощной и удобной надстройки для Excel. По мере продвижения вы будете углубляться в детали каждого компонента и адаптировать архитектуру под конкретные нужды вашего проекта.
